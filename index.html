<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>√în t·∫≠p t·ª´ v·ª±ng</title>
    <style>
        @font-face {
  font-family: 'HL Hoctro';
  src: url('HLHOCTRO.TTF')
}
        
        body{;max-width:1000px;margin:24px auto;padding:0 16px;color:#222;text-align:center;position:relative;min-height:100vh;
        }

    h1{font-size:20px;text-align:left;}
    input[type=file]{margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:12px;text-align:left}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f5f5f5}
    .hint{color:#555;font-size:13px;text-align:left;}
    .error{color:#b00020;text-align:left}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;justify-content:center}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    #random-word{background:#009c3d;color:white;}
    #translate-btn{background:#ffbf00;color:white;}
    #translate-reverse-btn{background:#f51c1b;color:white;}

    /* Random word display */
    #randomWordContainer{display:none;flex-direction:column;align-items:center;padding-top:20px;margin-top:20px;max-width:100%;overflow:hidden;}
    #modeLabel{font-size:3vw;font-weight:bold;margin-bottom:10px;}
    #modeLabel.fill{color:blue;}
    #modeLabel.en2vi{color:deeppink;}
    #modeLabel.vi2en{color:green;}

    #randomWord{margin-top:40px;display:flex;flex-wrap:nowrap;justify-content:center;white-space:nowrap;font-size:10vw;opacity:0;transition:opacity 1s ease-in;max-width:100%;box-sizing:border-box;font-family: 'HL Hoctro';}
    #randomWord.show{opacity:1;animation:highlight 1.5s ease-in-out}
    .random-label{display:inline-block;min-width:0.6em;text-align:center;border-bottom:3px solid #ccc;margin:5px;}
    .random-label.visible{color:blue}
    .random-label.hidden{color:red}

    .hint-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:40px}
    .subtitle{font-size:36px;color:black;opacity:0;transition:opacity 1s ease-in;}
    .subtitle.show{opacity:1;animation:highlightSubtitle 1.5s ease-in-out}

    @keyframes highlight {
      0% { background-color: yellow; }
      100% { background-color: transparent; }
    }
    @keyframes highlightSubtitle {
      0% { background-color: lightgreen; }
      100% { background-color: transparent; }
    }
  </style>
</head>

<body>
    <h1>√în t·∫≠p t·ª´ v·ª±ng</h1>
    <p class="hint">Ch·ªçn file Excel danh s√°ch t·ª´ v·ª±ng. C·ªôt A l√† ng√¥n ng·ªØ 1, c·ªôt B l√† ng√¥n ng·ªØ 2</p>
    <input id="file-input" type="file" accept=".xlsx,.xls,.csv" />
    <button id="google-sheet-btn">ƒê·ªçc link google sheet</button>
    <div class="controls">
        <button id="back-btn" disabled>Tr·ªü l·∫°i danh s√°ch</button></div>
    <span id="status" class="hint"></span>
    <div id="error" class="error"></div>
    <div class="controls">
            <button id="translate-btn" disabled>D·ªãch t·ª´ sang ti·∫øng Vi·ªát</button>
            <button id="random-word" disabled>ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng (D·ªÖ)</button>
            <button id="translate-reverse-btn" disabled>ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng (Kh√≥)</button>
        </div>
    <div id="table-wrap"></div>
    <div id="randomWordContainer">
        <div id="modeLabel"></div>
        <div class="hint-row">
            <div id="hint" class="subtitle"></div>
            <button id="reveal-btn" disabled>ƒê√°p √°n</button>
            <button id="speak-btn" disabled>Ph√°t √¢m ti·∫øng Anh üîä</button>
        </div>
        <div id="randomWord"></div>
    </div>
    <!-- SheetJS (xlsx) library t·ª´ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
    const input = document.getElementById('file-input');
    const tableWrap = document.getElementById('table-wrap');
    const errorEl = document.getElementById('error');
    const status = document.getElementById('status');
    const randomBtn = document.getElementById('random-word');
    const translateBtn = document.getElementById('translate-btn');
    const translateReverseBtn = document.getElementById('translate-reverse-btn');
    const backBtn = document.getElementById('back-btn');
    const googleSheetBtn = document.getElementById('google-sheet-btn');
    const randomWordDiv = document.getElementById('randomWord');
    const randomWordContainer = document.getElementById('randomWordContainer');
    const hintDiv = document.getElementById('hint');
    const revealBtn = document.getElementById('reveal-btn');
    const speakBtn = document.getElementById('speak-btn');
    const modeLabel = document.getElementById('modeLabel');

    let rows = [];
    let currentMode = null; // 'fill', 'en2vi', 'vi2en'
    let currentRow = null;

    function resetUI() {
        tableWrap.innerHTML = '';
        errorEl.textContent = '';
        status.textContent = '';
        randomBtn.disabled = true;
        translateBtn.disabled = true;
        translateReverseBtn.disabled = true;
        backBtn.disabled = true;
        revealBtn.disabled = true;
        speakBtn.disabled = true;
        randomWordDiv.innerHTML = '';
        randomWordDiv.classList.remove('show');
        hintDiv.textContent = '';
        hintDiv.classList.remove('show');
        randomWordContainer.style.display = 'none';
        currentMode = null;
        currentRow = null;
        modeLabel.textContent = '';
        modeLabel.className = '';
    }
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1zYGaKPYvT9_0c60qMY-PdCEWUucCdtWgvCGSvSInFRc/export?format=csv&id=1zYGaKPYvT9_0c60qMY-PdCEWUucCdtWgvCGSvSInFRc&gid=0';

    async function readGoogleSheet(sheetUrl) {
        try {
            resetUI();
            status.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...';

            // T·∫£i CSV tr·ª±c ti·∫øp t·ª´ link Google Sheets
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets');
            const csvText = await response.text();

            // D√πng XLSX ƒë·ªÉ parse CSV th√†nh sheet
            const workbook = XLSX.read(csvText, { type: 'string' });
            const firstSheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[firstSheetName];
            const sheetRange = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

            rows = sheetRange.map(r => [r[0] ?? '', r[1] ?? '']);
            makeTable(rows);

            randomBtn.disabled = false;
            translateBtn.disabled = false;
            translateReverseBtn.disabled = false;

            status.textContent = '‚úÖ ƒê√£ ƒë·ªçc xong Google Sheet';
        } catch (err) {
            console.error(err);
            errorEl.textContent = 'L·ªói khi ƒë·ªçc sheet: ' + (err.message || err);
            status.textContent = '';
        }
    }

    function speak(txtToSpeak) {
        console.log("speak: " + txtToSpeak);
        if (txtToSpeak == '')
            return;
        const text = txtToSpeak;
        const utterance = new SpeechSynthesisUtterance(text);
        //utterance.pitch = 0.75;
        //utterance.rate = 0.75;
        utterance.lang = 'en-US'; // gi·ªçng ti·∫øng Anh M·ªπ

        speechSynthesis.speak(utterance);
    }

    function makeTable(data) {
        if (!data.length) {
            tableWrap.innerHTML = '<p class="hint">Kh√¥ng c√≥ d·ªØ li·ªáu trong c·ªôt A v√† B.</p>';
            return;
        }
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>H√†ng</th><th>C·ªôt A</th><th>C·ªôt B</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        data.forEach((r, i) => {
            const tr = document.createElement('tr');
            const idx = document.createElement('td');
            idx.textContent = i + 1;
            const a = document.createElement('td');
            a.textContent = r[0] ?? '';
            const b = document.createElement('td');
            b.textContent = r[1] ?? '';
            tr.appendChild(idx);
            tr.appendChild(a);
            tr.appendChild(b);
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.innerHTML = '';
        tableWrap.appendChild(table);
        status.textContent = `ƒê√£ ƒë·ªçc ${data.length} h√†ng t·ª´ sheet "Vocabulary"`;
    }

    input.addEventListener('change', async (ev) => {
        resetUI();
        const file = ev.target.files && ev.target.files[0];
        if (!file) return;
        status.textContent = `ƒêang ƒë·ªçc: ${file.name}`;
        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[firstSheetName];
            const sheetRange = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
            rows = sheetRange.map(r => [r[0] ?? '', r[1] ?? '']);
            makeTable(rows);
            randomBtn.disabled = false;
            translateBtn.disabled = false;
            translateReverseBtn.disabled = false;
        } catch (err) {
            console.error(err);
            errorEl.textContent = 'L·ªói khi ƒë·ªçc file: ' + (err.message || err);
            status.textContent = '';
        }
    });

    function shuffleArray(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
    }

    function adjustFontSize() {
        const container = randomWordDiv;
        let fontSize = 10; // in vw
        container.style.fontSize = fontSize + 'vw';
        while (container.scrollWidth > container.clientWidth && fontSize > 1) {
            fontSize -= 0.5;
            container.style.fontSize = fontSize + 'vw';
        }
    }

    function pickRandomRow() {
        const validRows = rows.filter(r => r[0] || r[1]);
        if (!validRows.length) {
            errorEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu trong c·ªôt A ho·∫∑c B';
            return null;
        }
        return validRows[Math.floor(Math.random() * validRows.length)];
    }

    randomBtn.addEventListener('click', () => {
        fillintheblank('half');
    });

    function fillintheblank(mode) {

        if (mode == 'half') {

            currentMode = 'fill';
            currentRow = pickRandomRow();
            if (!currentRow) return;
            modeLabel.textContent = 'Nhi·ªám v·ª• th·ª≠ th√°ch: ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng';
            modeLabel.className = 'fill';

            const randWord = String(currentRow[0]);
            const hint = currentRow[1] ?? '';
            tableWrap.style.display = 'none';
            status.textContent = '';
            randomWordDiv.innerHTML = '';
            hintDiv.textContent = '';
            randomWordDiv.classList.remove('show');
            hintDiv.classList.remove('show');

            const chars = randWord.split('');
            const positions = [];
            chars.forEach((c, i) => { if (c !== ' ') positions.push(i); });
            const nonSpaceCount = positions.length;
            let hideCount = Math.floor(nonSpaceCount / 3);
            if (nonSpaceCount < 3) hideCount = 1;

            shuffleArray(positions);
            console.log(positions);
            const hideIndices = new Set(positions.slice(0, hideCount));
            console.log(hideIndices);

            chars.forEach((c, i) => {
                const span = document.createElement('span');
                span.classList.add('random-label');
                if (c === ' ') {
                    span.textContent = '\u00A0';
                    span.style.borderBottom = 'none';
                } else if (hideIndices.has(i)) {
                    span.dataset.ch = c;
                    span.textContent = '_';
                    span.classList.add('hidden');
                } else {
                    span.textContent = c;
                    span.classList.add('visible');
                }
                randomWordDiv.appendChild(span);
            });

            // Hi·ªÉn th·ªã g·ª£i √Ω (c·ªôt B) ngay khi v√†o ch·∫ø ƒë·ªô ƒêi·ªÅn t·ª´
            hintDiv.textContent = hint;
            requestAnimationFrame(() => hintDiv.classList.add('show'));

            revealBtn.disabled = false;
            speakBtn.disabled = false;
            randomWordContainer.style.display = 'flex';
            requestAnimationFrame(() => {
                randomWordDiv.classList.add('show');
                adjustFontSize();
            });
            backBtn.disabled = false;
        } else {
            currentMode = 'fill';
            currentRow = pickRandomRow();
            if (!currentRow) return;
            modeLabel.textContent = 'Nhi·ªám v·ª• th·ª≠ th√°ch: ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng';
            modeLabel.className = 'fill';

            const randWord = String(currentRow[0]);
            const hint = currentRow[1] ?? '';
            tableWrap.style.display = 'none';
            status.textContent = '';
            randomWordDiv.innerHTML = '';
            hintDiv.textContent = '';
            randomWordDiv.classList.remove('show');
            hintDiv.classList.remove('show');

            const chars = randWord.split('');
            const positions = [];
            chars.forEach((c, i) => { if (c !== ' ') positions.push(i); });
            const nonSpaceCount = positions.length;
            let hideCount = nonSpaceCount;
            if (nonSpaceCount < 3) hideCount = 1;

            shuffleArray(positions);
            const hideIndices = new Set(positions.slice(0, hideCount));

            chars.forEach((c, i) => {
                const span = document.createElement('span');
                span.classList.add('random-label');
                if (c === ' ') {
                    span.textContent = '\u00A0';
                    span.style.borderBottom = 'none';
                } else if (i != 0) {
                    span.dataset.ch = c;
                    span.textContent = '_';
                    span.classList.add('hidden');
                } else {
                    span.textContent = c;
                    span.classList.add('visible');
                }
                randomWordDiv.appendChild(span);
            });

            // Hi·ªÉn th·ªã g·ª£i √Ω (c·ªôt B) ngay khi v√†o ch·∫ø ƒë·ªô ƒêi·ªÅn t·ª´
            hintDiv.textContent = hint;
            requestAnimationFrame(() => hintDiv.classList.add('show'));

            revealBtn.disabled = false;
            speakBtn.disabled = false;
            randomWordContainer.style.display = 'flex';
            requestAnimationFrame(() => {
                randomWordDiv.classList.add('show');
                adjustFontSize();
            });
            backBtn.disabled = false;
        }
    }

    googleSheetBtn.addEventListener('click', () => {
        readGoogleSheet(sheetUrl);
    });

    translateBtn.addEventListener('click', () => {
        currentMode = 'en2vi';
        currentRow = pickRandomRow();
        if (!currentRow) return;
        modeLabel.textContent = 'Nhi·ªám v·ª• th·ª≠ th√°ch: ƒê·ªçc l·ªõn v√† d·ªãch nghƒ©a sang ti·∫øng Vi·ªát';
        modeLabel.className = 'en2vi';

        const randWord = String(currentRow[0]);
        const hint = currentRow[1] ?? '';
        tableWrap.style.display = 'none';
        status.textContent = '';
        randomWordDiv.innerHTML = '';
        hintDiv.textContent = '';
        randomWordDiv.classList.remove('show');
        hintDiv.classList.remove('show');

        const chars = randWord.split('');
        chars.forEach((c, i) => {
            const span = document.createElement('span');
            span.classList.add('random-label', 'visible');
            span.textContent = c === ' ' ? '\u00A0' : c;
            if (c === ' ') span.style.borderBottom = 'none';
            randomWordDiv.appendChild(span);
        });

        revealBtn.disabled = false;
        speakBtn.disabled = false;
        randomWordContainer.style.display = 'flex';
        requestAnimationFrame(() => {
            randomWordDiv.classList.add('show');
            adjustFontSize();
        });
        backBtn.disabled = false;
    });

    translateReverseBtn.addEventListener('click', () => {
        fillintheblank('full');
    });

    revealBtn.addEventListener('click', () => {
        if (!currentRow) return;
        if (currentMode === 'fill') {
            const labels = document.querySelectorAll('#randomWord .random-label');
            labels.forEach(lbl => {
                if (lbl.dataset.ch) {
                    lbl.textContent = lbl.dataset.ch;
                    lbl.classList.remove('hidden');
                    lbl.classList.add('visible');
                    delete lbl.dataset.ch;
                }
            });
        } else if (currentMode === 'en2vi') {
            hintDiv.textContent = currentRow[1] ?? '';
            requestAnimationFrame(() => hintDiv.classList.add('show'));
        } else if (currentMode === 'vi2en') {
            hintDiv.textContent = currentRow[0] ?? '';
            requestAnimationFrame(() => hintDiv.classList.add('show'));
        }
        revealBtn.disabled = true;
    });

    speakBtn.addEventListener('click', () => {
        console.log(currentRow[0]);
        if (!currentRow) return;
        if (currentMode === 'fill') {
            console.log(currentRow[0]);
            speak(currentRow[0] ?? '');
        } else if (currentMode === 'en2vi') {
            speak(currentRow[0] ?? '');
        } else if (currentMode === 'vi2en') {
            speak(currentRow[0] ?? '');
        }
    });

    backBtn.addEventListener('click', () => {
        randomWordDiv.innerHTML = '';
        randomWordDiv.classList.remove('show');
        hintDiv.textContent = '';
        hintDiv.classList.remove('show');
        randomWordContainer.style.display = 'none';
        tableWrap.style.display = '';
        revealBtn.disabled = true;
        backBtn.disabled = true;
        currentRow = null;
        currentMode = null;
        modeLabel.textContent = '';
        modeLabel.className = '';
        if (rows.length) {
            status.textContent = `ƒê√£ ƒë·ªçc ${rows.length} h√†ng t·ª´ sheet \"Vocabulary\"`;
        }
    });

    resetUI();
    </script>
</body>

</html>
